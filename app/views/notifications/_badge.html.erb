<%# Notification badge - dropdown on desktop, direct link on mobile %>
<li class="nav-item dropdown" data-controller="notifications">
  <%# Mobile: Direct link to notifications page (hidden on desktop) %>
  <%= link_to notifications_path,
      class: "nav-link position-relative d-flex align-items-center justify-content-center d-md-none",
      id: "notification-badge-mobile",
      data: { turbo_prefetch: false },
      aria: { label: t("notifications.title") } do %>
    <i class="bi bi-bell"></i>
    <% if current_user.has_unread_notifications? %>
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-count-mobile">
        <%= current_user.unread_notifications_count %>
      </span>
    <% end %>
  <% end %>
  
  <%# Desktop: Dropdown toggle (hidden on mobile) %>
  <%= link_to "#",
      class: "nav-link position-relative d-none d-md-inline-flex align-items-center justify-content-center",
      id: "notification-badge",
      data: { 
        bs_toggle: "dropdown",
        bs_auto_close: "outside",
        turbo_prefetch: false
      },
      aria: { haspopup: true, expanded: false } do %>
    <i class="bi bi-bell"></i>
    <% if current_user.has_unread_notifications? %>
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-count">
        <%= current_user.unread_notifications_count %>
      </span>
    <% end %>
  <% end %>
  
  <%# Dropdown menu with notifications - desktop only (hidden on mobile) %>
  <div class="dropdown-menu dropdown-menu-end notification-dropdown">
    <%# Sticky header %>
    <div class="notification-dropdown-header d-flex justify-content-between align-items-center p-2 border-bottom">
      <h6 class="mb-0"><%= t("notifications.title") %></h6>
      <% if current_user.has_unread_notifications? %>
        <%= button_to mark_all_as_read_notifications_path,
            method: :patch,
            class: "btn btn-sm btn-link text-decoration-none p-0",
            form: { data: { turbo_stream: true } } do %>
          <%= t("notifications.mark_all_as_read") %>
        <% end %>
      <% end %>
    </div>
    <%# Scrollable notifications list %>
    <div class="notification-dropdown-body" id="notifications-list">
      <%= render "notifications/list", notifications: current_user.notifications.limit(10).order(created_at: :desc) %>
    </div>
    <%# Sticky footer %>
    <div class="notification-dropdown-footer p-2 border-top text-center">
      <%= link_to t("notifications.view_all"), notifications_path, class: "btn btn-sm btn-outline-primary" %>
    </div>
  </div>
  
  <%# Subscribe to real-time notification updates via Action Cable %>
  <%# Noticed broadcasts to stream_for recipient, which creates: "noticed::notification_channel:user_#{user.id}" %>
  <%= turbo_stream_from "noticed::notification_channel", current_user %>
</li>

