<%# Remove empty message if this is the first comment %>
<%= turbo_stream.remove "comments-empty" if @comment.parent_id.nil? %>

<%# If this is a reply, append it to the parent's replies container %>
<%# If this is a top-level comment, prepend it to the comments list %>
<% if @comment.parent_id.present? %>
  <%# Calculate depth by counting parent chain %>
  <% parent = @comment.parent %>
  <% depth = 0 %>
  <% while parent&.parent_id.present? %>
    <% depth += 1 %>
    <% parent = parent.parent %>
  <% end %>
  <% depth += 1 %>
  
  <%= turbo_stream.append "comment-#{@comment.parent_id}-replies" do %>
    <%= render "comments/comment", comment: @comment, depth: depth, allow_replies: true %>
  <% end %>
  
  <%# Collapse the reply form using JavaScript %>
  <%= turbo_stream.append "comment-#{@comment.parent_id}-replies" do %>
    <script>
      (function() {
        var collapseElement = document.getElementById('reply-form-<%= @comment.parent_id %>');
        if (collapseElement) {
          var bsCollapse = bootstrap.Collapse.getInstance(collapseElement) || new bootstrap.Collapse(collapseElement);
          bsCollapse.hide();
        }
      })();
    </script>
  <% end %>
<% else %>
  <%= turbo_stream.prepend "comments-list" do %>
    <%= render "comments/comment", comment: @comment, depth: 0, allow_replies: true %>
  <% end %>
<% end %>

<%# Reset the comment form if this was a top-level comment %>
<% if @comment.parent_id.nil? %>
  <%# Find the form and reset it %>
  <%= turbo_stream.append "comments-list" do %>
    <script>
      (function() {
        var form = document.querySelector('form[action*="comments"]:not([action*="upvote"]):not([action*="delete"])');
        if (form) {
          form.reset();
          var textarea = form.querySelector('textarea');
          if (textarea) {
            textarea.value = '';
          }
        }
      })();
    </script>
  <% end %>
<% end %>

<%# Show flash message %>
<% if notice %>
  <%= turbo_stream.append "flash-messages" do %>
    <div class="alert alert-info alert-dismissible fade show m-1" role="alert" data-controller="flash" data-flash-auto-dismiss-value="<%= flash_auto_dismiss_time %>">
      <span class="alert-message"><%= notice %></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="<%= t("navigation.close") %>"></button>
    </div>
  <% end %>
<% end %>
