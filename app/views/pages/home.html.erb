<!-- Divider beneath navbar to visually separate navigation from content -->
<div class="border-bottom"></div>

<!-- Full-width layout with side banners -->
<div class="container-fluid px-0">
  <div class="row g-0">
    <!-- Left Ad Banner (columns 1-2) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-end position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>

    <!-- Main Content (columns 3-10) - adjusted for wider banners -->
    <div class="col-lg-8">
      <div class="container py-4">
  <!-- Hero section with heading and article cards -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-8">
      <div class="text-center mb-4">
        <p class="lead text-muted mb-3"><%= t("pages.home.hero.heading") %></p>
        <p class="text-muted mb-4"><%= t("pages.home.hero.subheading") %></p>
      </div>
      
      <!-- Article cards -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
          <%= link_to "#", class: "card text-decoration-none card-hover h-100 overflow-hidden article-card" do %>
            <div class="card-body d-flex align-items-center justify-content-center position-relative" style="min-height: 120px; background-image: url('https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=400&h=200&fit=crop'); background-size: cover; background-position: center;">
              <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);"></div>
              <h6 class="card-title mb-0 text-white position-relative z-1"><%= t("pages.home.hero.articles.newest") %></h6>
            </div>
          <% end %>
        </div>
        <div class="col-12 col-md-4">
          <%= link_to "#", class: "card text-decoration-none card-hover h-100 overflow-hidden article-card" do %>
            <div class="card-body d-flex align-items-center justify-content-center position-relative" style="min-height: 120px; background-image: url('https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=400&h=200&fit=crop'); background-size: cover; background-position: center;">
              <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.8) 0%, rgba(245, 87, 108, 0.8) 100%);"></div>
              <h6 class="card-title mb-0 text-white position-relative z-1"><%= t("pages.home.hero.articles.roadmaps") %></h6>
            </div>
          <% end %>
        </div>
        <div class="col-12 col-md-4">
          <%= link_to "#", class: "card text-decoration-none card-hover h-100 overflow-hidden article-card" do %>
            <div class="card-body d-flex align-items-center justify-content-center position-relative" style="min-height: 120px; background-image: url('https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=400&h=200&fit=crop'); background-size: cover; background-position: center;">
              <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.8) 0%, rgba(0, 242, 254, 0.8) 100%);"></div>
              <h6 class="card-title mb-0 text-white position-relative z-1"><%= t("pages.home.hero.articles.about_us") %></h6>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="border-bottom mb-4"></div>

  <!-- Hero search bar centered within 8-grid width on large screens -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-8">
      <%= form_with url: root_path,
                    method: :get,
                    local: false,
                    data: { turbo_stream: true },
                    role: "search",
                    class: "row g-2 align-items-center" do |form| %>
        <div class="col-12 col-md-9">
          <%= form.search_field :query,
                                value: params[:query],
                                id: "tool-search-input",
                                class: "form-control form-control-lg",
                                placeholder: t("pages.home.search_placeholder"),
                                aria: { label: t("pages.home.search_placeholder") },
                                oninput: "debounceSearch(this)" %>
        </div>
        <div class="col-12 col-md-3 d-grid">
          <%= form.submit t("actions.search"), class: "btn btn-primary btn-lg" %>
        </div>
        <!-- Hidden field to preserve category selection -->
        <%= hidden_field_tag :category, params[:category] || "trending" %>
      <% end %>
    </div>
  </div>

  <div class="border-bottom mb-4"></div>

  <!-- Category toggles to swap tool lists without full reload (JS-ready) -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-8">
      <div class="btn-group w-100" role="group" aria-label="<%= t('pages.home.category_aria_label') %>">
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'trending' %> category-toggle" data-category="trending" aria-pressed="<%= @category == 'trending' %>">
          <%= t("pages.home.categories.trending") %>
        </button>
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'new' %> category-toggle" data-category="new" aria-pressed="<%= @category == 'new' %>">
          <%= t("pages.home.categories.new_hot") %>
        </button>
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'upvoted' %> category-toggle" data-category="upvoted" aria-pressed="<%= @category == 'upvoted' %>">
          <%= t("pages.home.categories.most_upvoted") %>
        </button>
      </div>
    </div>
  </div>

  <!-- Three-column layout: side rails for promos and center column for tool cards -->
  <div class="row g-3 justify-content-center">
    <div class="col-12 col-lg-10">
      <% panels = { "trending" => @trending_tools, "new" => @new_hot_tools, "upvoted" => @most_upvoted_tools } %>

      <% panels.each_with_index do |(panel, tools), panel_idx| %>
        <div class="card shadow-sm mb-3 card-hover <%= 'd-none' unless @category == panel %>" data-category-panel="<%= panel %>" id="category-panel-<%= panel %>">
          <div class="card-body">
            <% if tools.blank? %>
              <p class="text-muted mb-0"><%= t("pages.home.list_placeholder") %></p>
            <% else %>
              <% tools.each_with_index do |tool, i| %>
                <% upvotes = (tool.respond_to?(:upvotes_count) && tool.upvotes_count.present?) ? tool.upvotes_count.to_i : 0 %>
                <%= render partial: "tool_card", locals: { tool: tool, index: i, upvotes: upvotes } %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
      </div>
    </div>

    <!-- Right Ad Banner (columns 11-12) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-start position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  (function() {
    // Prevent duplicate initialization by checking if handlers are already set up
    if (window.homePageHandlersInitialized) {
      // Just reattach handlers for this page load
      const reattachHandlers = () => {
        const buttons = Array.from(document.querySelectorAll(".category-toggle"));
        const panels = Array.from(document.querySelectorAll("[data-category-panel]"));
        if (buttons.length && panels.length) {
          const showCategory = (category) => {
            buttons.forEach((btn) => {
              const isActive = btn.dataset.category === category;
              btn.classList.toggle("active", isActive);
              btn.setAttribute("aria-pressed", isActive);
            });
            panels.forEach((panel) => {
              const isTarget = panel.dataset.categoryPanel === category;
              panel.classList.toggle("d-none", !isTarget);
            });
          };
        }
        
        // Reattach upvote handlers
        const signedIn = <%= user_signed_in? ? 'true' : 'false' %>;
        const guestMessage = "<%= j t('pages.home.card.upvote_guest_alert') %>";
        document.querySelectorAll(".upvote-button").forEach((button) => {
          const countSpan = button.querySelector("[data-upvote-count]");
          const handler = (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (!signedIn) {
              alert(guestMessage);
              return;
            }
            const current = parseInt(button.dataset.count || "0", 10);
            const next = current + 1;
            button.dataset.count = next;
            if (countSpan) {
              countSpan.textContent = `<%= t("pages.home.card.upvotes", count: "%{count}") %>`.replace("%{count}", next);
            }
          };
          button.addEventListener("click", handler);
        });
      };
      
      // Use turbo:load with once: true to prevent duplicates
      document.addEventListener("turbo:load", reattachHandlers, { once: true });
      if (document.readyState !== 'loading') {
        reattachHandlers();
      }
      return;
    }
    
    window.homePageHandlersInitialized = true;
    
    // Store button handlers to prevent duplicates
    const buttonHandlers = new WeakMap();
    const upvoteHandlers = new WeakMap();
    
  // Simple client-side toggle to switch between category panels without reload.
  const attachCategoryToggle = () => {
    const buttons = Array.from(document.querySelectorAll(".category-toggle"));
    const panels = Array.from(document.querySelectorAll("[data-category-panel]"));

    if (!buttons.length || !panels.length) return;

    const showCategory = (category) => {
      buttons.forEach((btn) => {
        const isActive = btn.dataset.category === category;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-pressed", isActive);
      });

      panels.forEach((panel) => {
        const isTarget = panel.dataset.categoryPanel === category;
        panel.classList.toggle("d-none", !isTarget);
      });
    };

    buttons.forEach((btn) => {
        // Remove old listener if it exists
        const oldHandler = buttonHandlers.get(btn);
        if (oldHandler) {
          btn.removeEventListener("click", oldHandler);
        }
        
        const handler = () => {
        const category = btn.dataset.category;
        showCategory(category);
        // Update hidden field in search form
        const categoryInput = document.querySelector('input[name="category"]');
        if (categoryInput) {
          categoryInput.value = category;
        }
        // Submit form to update results
        const form = btn.closest('.container').querySelector('form');
        if (form) {
          form.requestSubmit();
        }
        };
        
        btn.addEventListener("click", handler);
        buttonHandlers.set(btn, handler);
    });
  };

  // Debounce function for search input
  let searchTimeout;
    window.debounceSearch = function(input) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      input.form.requestSubmit();
    }, 300); // Wait 300ms after user stops typing
    };

  const attachUpvoteHandlers = () => {
    const signedIn = <%= user_signed_in? ? 'true' : 'false' %>;
    const guestMessage = "<%= j t('pages.home.card.upvote_guest_alert') %>";

    document.querySelectorAll(".upvote-button").forEach((button) => {
        // Remove old listener if it exists
        const oldHandler = upvoteHandlers.get(button);
        if (oldHandler) {
          button.removeEventListener("click", oldHandler);
        }
        
      const countSpan = button.querySelector("[data-upvote-count]");
        const handler = (event) => {
        event.preventDefault();
        event.stopPropagation();

        if (!signedIn) {
          alert(guestMessage);
          return;
        }

        const current = parseInt(button.dataset.count || "0", 10);
        const next = current + 1;
        button.dataset.count = next;
        if (countSpan) {
          countSpan.textContent = `<%= t("pages.home.card.upvotes", count: "%{count}") %>`.replace("%{count}", next);
        }
        };
        
        button.addEventListener("click", handler);
        upvoteHandlers.set(button, handler);
    });
  };

  // Reattach handlers after Turbo Stream updates
  const reattachHandlers = () => {
    attachCategoryToggle();
    attachUpvoteHandlers();
  };

    // Use turbo:load only (not DOMContentLoaded) to avoid duplicate listeners
    // Use once: false so handlers work on every navigation
  document.addEventListener("turbo:load", reattachHandlers);
  document.addEventListener("turbo:frame-load", reattachHandlers);
    
    // Initial attachment if page is already loaded
    if (document.readyState !== 'loading') {
      reattachHandlers();
    }
  })();
<% end %>

<style>
  /* Modest but noticeable hover for cards */
  .card-hover {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .card-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.65rem 1.5rem rgba(0,0,0,0.08);
  }

  /* Side banner styling - sticky from navbar to bottom of viewport */
  .side-banner {
    position: sticky;
    top: 2rem; /* Add space between navbar and banner */
    height: calc(100vh - 56px - 2rem); /* Subtract navbar height and top spacing */
    max-height: calc(100vh - 56px - 2rem);
    overflow-y: auto;
    padding-top: 1rem; /* Additional padding for visual spacing */
  }

  @media (max-width: 991.98px) {
    .side-banner {
      display: none !important;
    }
  }

  /* Make article cards look like list items on mobile - narrow and compact */
  @media (max-width: 767.98px) {
    .article-card {
      max-width: 280px;
      margin: 0 auto 0.75rem auto; /* Center and reduce spacing */
    }
    .article-card .card-body {
      min-height: 60px !important; /* Much shorter - list-like height */
      padding: 0.75rem 1rem !important; /* Compact padding */
    }
    .article-card h6 {
      font-size: 0.875rem; /* Smaller text */
      font-weight: 500;
    }
    .article-card .row {
      margin-bottom: 0.5rem !important; /* Reduce gap between cards */
    }
  }
</style>
