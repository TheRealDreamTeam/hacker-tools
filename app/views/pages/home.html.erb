<!-- Divider beneath navbar to visually separate navigation from content -->
<div class="border-bottom"></div>

<div class="container py-4">
  <!-- Hero search bar centered within 8-grid width on large screens -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-8">
      <%= form_with url: root_path,
                    method: :get,
                    local: false,
                    data: { turbo_stream: true },
                    role: "search",
                    class: "row g-2 align-items-center" do |form| %>
        <div class="col-12 col-md-9">
          <%= form.search_field :query,
                                value: params[:query],
                                id: "tool-search-input",
                                class: "form-control form-control-lg",
                                placeholder: t("pages.home.search_placeholder"),
                                aria: { label: t("pages.home.search_placeholder") },
                                oninput: "debounceSearch(this)" %>
        </div>
        <div class="col-12 col-md-3 d-grid">
          <%= form.submit t("actions.search"), class: "btn btn-primary btn-lg" %>
        </div>
        <!-- Hidden field to preserve category selection -->
        <%= hidden_field_tag :category, params[:category] || "trending" %>
      <% end %>
    </div>
  </div>

  <div class="border-bottom mb-4"></div>

  <!-- Category toggles to swap tool lists without full reload (JS-ready) -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-lg-8">
      <div class="btn-group w-100" role="group" aria-label="<%= t('pages.home.category_aria_label') %>">
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'trending' %> category-toggle" data-category="trending" aria-pressed="<%= @category == 'trending' %>">
          <%= t("pages.home.categories.trending") %>
        </button>
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'new' %> category-toggle" data-category="new" aria-pressed="<%= @category == 'new' %>">
          <%= t("pages.home.categories.new_hot") %>
        </button>
        <button type="button" class="btn btn-outline-primary <%= 'active' if @category == 'upvoted' %> category-toggle" data-category="upvoted" aria-pressed="<%= @category == 'upvoted' %>">
          <%= t("pages.home.categories.most_upvoted") %>
        </button>
      </div>
    </div>
  </div>

  <!-- Three-column layout: side rails for promos and center column for tool cards -->
  <div class="row g-3 justify-content-center">
    <div class="col-12 col-lg-10">
      <% panels = { "trending" => @trending_tools, "new" => @new_hot_tools, "upvoted" => @most_upvoted_tools } %>

      <% panels.each_with_index do |(panel, tools), panel_idx| %>
        <div class="card shadow-sm mb-3 card-hover <%= 'd-none' unless @category == panel %>" data-category-panel="<%= panel %>" id="category-panel-<%= panel %>">
          <div class="card-body">
            <% if tools.blank? %>
              <p class="text-muted mb-0"><%= t("pages.home.list_placeholder") %></p>
            <% else %>
              <% tools.each_with_index do |tool, i| %>
                <% upvotes = (tool.respond_to?(:upvotes_count) && tool.upvotes_count.present?) ? tool.upvotes_count.to_i : 0 %>
                <%= render partial: "tool_card", locals: { tool: tool, index: i, upvotes: upvotes } %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  // Simple client-side toggle to switch between category panels without reload.
  const attachCategoryToggle = () => {
    const buttons = Array.from(document.querySelectorAll(".category-toggle"));
    const panels = Array.from(document.querySelectorAll("[data-category-panel]"));

    if (!buttons.length || !panels.length) return;

    const showCategory = (category) => {
      buttons.forEach((btn) => {
        const isActive = btn.dataset.category === category;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-pressed", isActive);
      });

      panels.forEach((panel) => {
        const isTarget = panel.dataset.categoryPanel === category;
        panel.classList.toggle("d-none", !isTarget);
      });
    };

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const category = btn.dataset.category;
        showCategory(category);
        // Update hidden field in search form
        const categoryInput = document.querySelector('input[name="category"]');
        if (categoryInput) {
          categoryInput.value = category;
        }
        // Submit form to update results
        const form = btn.closest('.container').querySelector('form');
        if (form) {
          form.requestSubmit();
        }
      });
    });
  };

  // Debounce function for search input
  let searchTimeout;
  function debounceSearch(input) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      input.form.requestSubmit();
    }, 300); // Wait 300ms after user stops typing
  }

  document.addEventListener("turbo:load", attachCategoryToggle);
  document.addEventListener("DOMContentLoaded", attachCategoryToggle);

  const attachUpvoteHandlers = () => {
    const signedIn = <%= user_signed_in? ? 'true' : 'false' %>;
    const guestMessage = "<%= j t('pages.home.card.upvote_guest_alert') %>";

    document.querySelectorAll(".upvote-button").forEach((button) => {
      const countSpan = button.querySelector("[data-upvote-count]");
      button.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();

        if (!signedIn) {
          alert(guestMessage);
          return;
        }

        const current = parseInt(button.dataset.count || "0", 10);
        const next = current + 1;
        button.dataset.count = next;
        if (countSpan) {
          countSpan.textContent = `<%= t("pages.home.card.upvotes", count: "%{count}") %>`.replace("%{count}", next);
        }
      });
    });
  };

  // Reattach handlers after Turbo Stream updates
  const reattachHandlers = () => {
    attachCategoryToggle();
    attachUpvoteHandlers();
  };

  document.addEventListener("turbo:load", reattachHandlers);
  document.addEventListener("DOMContentLoaded", reattachHandlers);
  document.addEventListener("turbo:frame-load", reattachHandlers);
<% end %>

<style>
  /* Modest but noticeable hover for cards */
  .card-hover {
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .card-hover:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.65rem 1.5rem rgba(0,0,0,0.08);
  }
</style>
