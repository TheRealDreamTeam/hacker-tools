<div class="p-2">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="h3 mb-2"><%= @tool.tool_name %></h1>
      <p class="text-secondary mb-1 d-flex align-items-center gap-2">
        <span><%= t("tools.show.owner", owner: display_user_name(@tool.user)) %></span>
        <%= render "tools/read_state", tool: @tool %>
      </p>
      <% if @tool.tool_url.present? %>
        <p class="mb-0">
          <%= link_to @tool.tool_url, @tool.tool_url, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none" %>
        </p>
      <% end %>
    </div>
    <div class="d-flex gap-2">
      <% if @tool.icon.attached? %>
        <%= image_tag @tool.icon, class: "rounded", style: "height: 64px; width: 64px; object-fit: cover;" %>
      <% end %>
    </div>
  </div>
  <div class="mb-3">
    <%= render "tools/interaction_buttons", tool: @tool %>
  </div>
  <div class="mb-4">
    <h2 class="h5"><%= t("tools.show.description") %></h2>
    <p><%= simple_format(@tool.tool_description) %></p>
  </div>
  <div class="mb-4">
    <h2 class="h5"><%= t("tools.show.author_note") %></h2>
    <p><%= simple_format(@tool.author_note) %></p>
  </div>
  <% if @tool.picture.attached? %>
    <div class="mb-4">
      <h2 class="h5"><%= t("tools.show.picture") %></h2>
      <%= image_tag @tool.picture, class: "img-fluid rounded" %>
    </div>
  <% end %>
  <div class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="h5 mb-0"><%= t("tools.show.tags_title") %></h2>
    <% if @tool.user == current_user %>
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#add-tag-form">
        <%= t("tools.actions.add_tag") %>
      </button>
    <% end %>
  </div>
  <div id="add-tag-form" class="collapse mb-3">
    <div class="card card-body">
      <h3 class="h6 mb-3"><%= t("tools.show.select_tag") %></h3>
      <% @available_tags.group_by(&:tag_type).each do |tag_type, tags| %>
        <div class="mb-3">
          <strong class="text-muted"><%= t("tags.tag_types.#{tag_type}") %>:</strong>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <% tags.each do |tag| %>
              <% unless @tool_tags.include?(tag) %>
                <%= button_to tag.display_name,
                              add_tag_tool_path(@tool, tag_id: tag.id),
                              method: :post,
                              class: "btn btn-sm btn-outline-secondary" %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  <% if @tool_tags.any? %>
    <div class="d-flex flex-wrap gap-2">
      <% @tool_tags.each do |tag| %>
        <span class="badge <%= tag_badge_class(tag.tag_type) %> d-flex align-items-center gap-1">
          <%= tag.display_name %>
          <% if @tool.user == current_user %>
            <%= button_to "×",
                          remove_tag_tool_path(@tool, tag_id: tag.id),
                          method: :delete,
                          class: "btn btn-sm p-0 border-0 bg-transparent text-white",
                          style: "font-size: 1.2em; line-height: 1;",
                          title: t("tools.actions.remove_tag") %>
          <% end %>
        </span>
      <% end %>
    </div>
  <% else %>
    <p class="text-muted mb-0"><%= t("tools.show.no_tags") %></p>
  <% end %>
</div>

<div class="d-flex gap-2">
  <% if @tool.user == current_user %>
    <%= link_to t("actions.edit"), edit_tool_path(@tool), class: "btn btn-outline-primary" %>
    <%= button_to t("actions.delete"), tool_path(@tool), method: :delete,
                  data: { turbo_confirm: t("tools.confirmations.destroy") },
                  class: "btn btn-outline-danger" %>
    <% end %>
    <%= link_to t("actions.back"), tools_path, class: "btn btn-secondary" %>
  </div>
  <hr class="my-5">
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 mb-0"><%= t("tools.show.comments_title") %></h2>
      <span class="badge bg-secondary"><%= @comments.size %></span>
    </div>
    <div class="mb-2">
      <div class="btn-group btn-group-sm" role="group">
        <%= link_to t("comments.sort.recent"), tool_path(@tool, sort_by: "recent"), class: "btn btn-outline-secondary #{@sort_by == 'recent' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.most_upvoted"), tool_path(@tool, sort_by: "most_upvoted"), class: "btn btn-outline-secondary #{@sort_by == 'most_upvoted' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.trending"), tool_path(@tool, sort_by: "trending"), class: "btn btn-outline-secondary #{@sort_by == 'trending' ? 'active' : ''}" %>
      </div>
    </div>
    <div class="mb-3">
      <%= render "comments/form", tool: @tool, comment: @new_comment, submit_label: t("comments.actions.post_comment"), placeholder: t("comments.form.comment_placeholder") %>
    </div>
    <% @comments.each do |comment| %>
      <%= render "comments/comment", comment: comment, depth: 0, allow_replies: true %>
    <% end %>
  </div>
  <hr class="my-4">
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0"><%= t("tools.show.flags_title") %></h2>
      <button class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" data-bs-target="#flag-form"><%= t("comments.actions.add_flag") %></button>
    </div>
    <div class="mb-2">
      <div class="btn-group btn-group-sm" role="group">
        <%= link_to t("comments.sort.recent"), tool_path(@tool, sort_by_flags: "recent"), class: "btn btn-outline-secondary #{@sort_by_flags == 'recent' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.most_upvoted"), tool_path(@tool, sort_by_flags: "most_upvoted"), class: "btn btn-outline-secondary #{@sort_by_flags == 'most_upvoted' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.trending"), tool_path(@tool, sort_by_flags: "trending"), class: "btn btn-outline-secondary #{@sort_by_flags == 'trending' ? 'active' : ''}" %>
      </div>
    </div>
    <div id="flag-form" class="collapse mb-3">
      <div class="card card-body">
        <%= render "comments/form",
                 tool: @tool,
                 comment: @new_flag,
                 submit_label: t("comments.actions.submit_flag"),
                 placeholder: t("comments.form.flag_placeholder"),
                 show_cancel: true,
                 collapse_target: "flag-form" %>
      </div>
    </div>
    <% if @flags.any? %>
      <div class="list-group">
        <% @flags.each do |flag| %>
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <p class="mb-1 fw-semibold"><%= display_user_name(flag.user) %></p>
              <p class="mb-2"><%= simple_format(flag.comment) %></p>
              <p class="text-secondary small mb-0"><%= l(flag.created_at, format: :short) %></p>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
              <%= button_to upvote_tool_comment_path(@tool, flag),
                          method: :post,
                          class: "btn btn-sm #{flag.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                          title: flag.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                <span>↑</span> <span><%= flag.upvote_count %></span>
              <% end %>
              <% if flag.solved? %>
                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
              <% else %>
                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
              <% end %>
              <% if @tool.user == current_user %>
                <%= button_to t("comments.actions.toggle_resolve"),
                            resolve_tool_comment_path(@tool, flag),
                            method: :patch,
                            class: "btn btn-sm btn-outline-primary" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-light border"><%= t("comments.empty.flags") %></div>
    <% end %>
  </div>
  <hr class="my-4">
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0"><%= t("tools.show.bugs_title") %></h2>
      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="collapse" data-bs-target="#bug-form"><%= t("comments.actions.add_bug") %></button>
    </div>
    <div class="mb-2">
      <div class="btn-group btn-group-sm" role="group">
        <%= link_to t("comments.sort.recent"), tool_path(@tool, sort_by_bugs: "recent"), class: "btn btn-outline-secondary #{@sort_by_bugs == 'recent' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.most_upvoted"), tool_path(@tool, sort_by_bugs: "most_upvoted"), class: "btn btn-outline-secondary #{@sort_by_bugs == 'most_upvoted' ? 'active' : ''}" %>
        <%= link_to t("comments.sort.trending"), tool_path(@tool, sort_by_bugs: "trending"), class: "btn btn-outline-secondary #{@sort_by_bugs == 'trending' ? 'active' : ''}" %>
      </div>
    </div>
    <div id="bug-form" class="collapse mb-3">
      <div class="card card-body">
        <%= render "comments/form",
                 tool: @tool,
                 comment: @new_bug,
                 submit_label: t("comments.actions.submit_bug"),
                 placeholder: t("comments.form.bug_placeholder"),
                 show_cancel: true,
                 collapse_target: "bug-form" %>
      </div>
    </div>
    <% if @bugs.any? %>
      <div class="list-group">
        <% @bugs.each do |bug| %>
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <p class="mb-1 fw-semibold"><%= display_user_name(bug.user) %></p>
              <p class="mb-2"><%= simple_format(bug.comment) %></p>
              <p class="text-secondary small mb-0"><%= l(bug.created_at, format: :short) %></p>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
              <%= button_to upvote_tool_comment_path(@tool, bug),
                          method: :post,
                          class: "btn btn-sm #{bug.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                          title: bug.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                <span>↑</span> <span><%= bug.upvote_count %></span>
              <% end %>
              <% if bug.solved? %>
                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
              <% else %>
                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
              <% end %>
              <% if @tool.user == current_user %>
                <%= button_to t("comments.actions.toggle_resolve"),
                            resolve_tool_comment_path(@tool, bug),
                            method: :patch,
                            class: "btn btn-sm btn-outline-primary" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-light border"><%= t("comments.empty.bugs") %></div>
    <% end %>
  </div>
</div>
