<!-- Full-width layout with side banners -->
<div class="container-fluid px-0">
  <div class="row g-0">
    <!-- Left Ad Banner (columns 1-2) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-end position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>

    <!-- Main Content (columns 3-10) - adjusted for wider banners -->
    <div class="col-12 col-lg-8">
      <div class="container py-4">
        <div class="p-2">
          <!-- Tool Card - full width -->
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card shadow-sm d-flex flex-column position-relative" style="border: 4px solid #272727 !important;">
                <div class="card-body d-flex flex-column position-relative" style="background-color: #f5f5f5;">
                  <!-- Tool Container with Title and Back Button on same height -->
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                        <h1 class="h3 mb-0"><%= @tool.tool_name %></h1>
                        <% if @tool.tool_url.present? %>
                          <%= link_to @tool.tool_url, target: "_blank", rel: "noopener noreferrer", class: "btn btn-sm btn-outline-primary visit-source-btn" do %>
                            <%= t("actions.visit_source") %>
                            <i class="bi bi-box-arrow-up-right"></i>
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                    <div class="d-flex gap-2 align-items-start">
                      <!-- Edit/Delete Buttons - same height as title -->
                      <div>
                        <%= link_to t("actions.edit"), edit_tool_path(@tool), class: "btn btn-outline-primary" %>
                        <%= render "shared/confirmation_modal",
                            id: "delete-tool-modal",
                            title: t("tools.confirmations.destroy_title"),
                            message: t("tools.confirmations.destroy_message"),
                            confirm_text: t("actions.delete"),
                            confirm_class: "btn-outline-danger",
                            form_action: tool_path(@tool),
                            form_method: :delete %>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#delete-tool-modal">
                          <%= t("actions.delete") %>
                        </button>
                        <%= link_to t("actions.back"), tools_path, class: "btn btn-secondary" %>
                      </div>
                      <% if @tool.icon.attached? %>
                        <%= image_tag @tool.icon, class: "rounded", style: "height: 64px; width: 64px; object-fit: cover;" %>
                      <% end %>
                    </div>
                  </div>
                  <div class="mb-3">
                    <%= render "tools/interaction_buttons", tool: @tool %>
                  </div>
                  <div class="mb-4">
                    <h2 class="h5"><%= t("tools.show.description") %></h2>
                    <p><%= simple_format(@tool.tool_description) %></p>
                  </div>
                  <% if @tool.picture.attached? %>
                    <div class="mb-4">
                      <h2 class="h5"><%= t("tools.show.picture") %></h2>
                      <%= image_tag @tool.picture, class: "rounded", style: "max-width: 64px; max-height: 64px; width: auto; height: auto; object-fit: contain;" %>
                    </div>
                  <% end %>
                  
                  <!-- Tags -->
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h5 mb-0"><%= t("tools.show.tags_title") %></h2>
                      <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#add-tag-form">
                        <%= t("tools.show.add_tag") %>
                      </button>
                    </div>
                    <div id="add-tag-form" class="collapse mb-3">
                      <div class="card card-body">
                        <h3 class="h6 mb-3"><%= t("tools.show.select_tag") %></h3>
                        <% @available_tags.group_by(&:tag_type).each do |tag_type, tags| %>
                          <div class="mb-3">
                            <strong class="text-muted"><%= t("tags.tag_types.#{tag_type}") %>:</strong>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                              <% tags.each do |tag| %>
                                <% unless @all_tool_tags.include?(tag) %>
                                  <%= button_to tag.display_name,
                                              add_tag_tool_path(@tool, tag_id: tag.id),
                                              method: :post,
                                              class: "btn btn-sm btn-outline-secondary",
                                              form: { data: { turbo: true } } %>
                                <% end %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                    <div id="tool-tags">
                      <% if @tool_tags.any? %>
                        <div class="d-flex flex-wrap gap-2" data-controller="tooltip">
                          <% @tool_tags.each do |tag| %>
                            <div class="d-inline-flex align-items-center gap-1">
                              <%= render_tag_link(tag) %>
                              <%= button_to "×",
                                          remove_tag_tool_path(@tool, tag_id: tag.id),
                                          method: :delete,
                                          class: "btn btn-sm btn-outline-danger p-0",
                                          style: "width: 20px; height: 20px; line-height: 1; font-size: 14px;",
                                          title: t("tools.actions.remove_tag"),
                                          form: { data: { turbo: true } } %>
                            </div>
                          <% end %>
                        </div>
                        <% if @all_tool_tags.count > @tool_tags.count %>
                          <p class="text-muted small mt-2 mb-0">
                            <%= t("tools.show.showing_top_tags", count: @tool_tags.count, total: @all_tool_tags.count) %>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#all-tags">
                              <%= t("tools.show.show_all_tags") %>
                            </button>
                          </p>
                          <div id="all-tags" class="collapse mt-2">
                            <div class="d-flex flex-wrap gap-2">
                              <% @all_tool_tags.each do |tag| %>
                                <% unless @tool_tags.map(&:id).include?(tag.id) %>
                                  <div class="d-inline-flex align-items-center gap-1">
                                    <% 
                                      badge_style = ""
                                      if tag.color.present?
                                        color_hex = color_name_to_hex(tag.color)
                                        badge_style = "background-color: #{color_hex};"
                                        if ["black", "navy", "purple", "indigo", "blue"].include?(tag.color.downcase)
                                          badge_style += " color: #ffffff;"
                                        else
                                          badge_style += " color: #000000;"
                                        end
                                      end
                                    %>
                                    <span class="badge <%= tag_badge_class(tag) %>" style="<%= badge_style %>">
                                      <%= tag.display_name %>
                                    </span>
                                    <%= button_to "×",
                                                remove_tag_tool_path(@tool, tag_id: tag.id),
                                                method: :delete,
                                                class: "btn btn-sm btn-outline-danger p-0",
                                                style: "width: 20px; height: 20px; line-height: 1; font-size: 14px;",
                                                title: t("tools.actions.remove_tag"),
                                                form: { data: { turbo: true } } %>
                                  </div>
                                <% end %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      <% else %>
                        <p class="text-muted mb-0"><%= t("tools.show.no_tags") %></p>
                      <% end %>
                    </div>
                  </div>
                  <span class="position-absolute bottom-0 end-0 mb-1 me-1">
                    <%= render "tools/read_state", tool: @tool %>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Discussion/Comments/Bugs/Flags with Tabs - takes 50% of grid size, Related Submissions takes 50% on desktop -->
          <div class="row g-4 mb-4">
            <div id="discussion-section" class="col-12 col-md-6 order-1">
              <div>
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab" aria-controls="discussion" aria-selected="true">
                      <%= t("tools.show.comments_title") %>
                      <span class="badge bg-secondary ms-2"><%= @comments.count.to_s %></span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bugs-tab" data-bs-toggle="tab" data-bs-target="#bugs" type="button" role="tab" aria-controls="bugs" aria-selected="false">
                      <%= t("tools.show.bugs_title") %>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flags-tab" data-bs-toggle="tab" data-bs-target="#flags" type="button" role="tab" aria-controls="flags" aria-selected="false">
                      <%= t("tools.show.flags_title") %>
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                  <!-- Discussion Tab -->
                  <div class="tab-pane fade show active" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                    <div class="mb-3">
                      <%= render "comments/form", tool: @tool, comment: @new_comment, submit_label: t("comments.actions.post_comment"), placeholder: t("comments.form.comment_placeholder") %>
                    </div>
                    <div class="mb-2">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{tool_path(@tool, sort_by: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{tool_path(@tool, sort_by: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{tool_path(@tool, sort_by: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'trending' ? 'active' : ''}" %>
                      </div>
                    </div>
                    <div id="comments-list">
                      <% if @comments.any? %>
                        <% @comments.each do |comment| %>
                          <%= render "comments/comment", comment: comment, depth: 0, allow_replies: true %>
                        <% end %>
                      <% else %>
                        <div id="comments-empty" class="alert alert-light border"><%= t("comments.empty.comments") %></div>
                      <% end %>
                    </div>
                  </div>

                  <!-- Bugs Tab -->
                  <div class="tab-pane fade" id="bugs" role="tabpanel" aria-labelledby="bugs-tab">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h6 mb-0"><%= t("tools.show.bugs_title") %></h2>
                    </div>
                    <div class="mb-2 d-flex justify-content-between gap-2 align-items-center flex-wrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{tool_path(@tool, sort_by_bugs: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{tool_path(@tool, sort_by_bugs: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{tool_path(@tool, sort_by_bugs: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'trending' ? 'active' : ''}" %>
                      </div>
                      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="collapse" data-bs-target="#bug-form"><%= t("comments.actions.add_bug") %></button>
                    </div>
                    <div id="bug-form" class="collapse mb-3">
                      <div class="card card-body">
                        <%= render "comments/form",
                                 tool: @tool,
                                 comment: @new_bug,
                                 submit_label: t("comments.actions.submit_bug"),
                                 placeholder: t("comments.form.bug_placeholder"),
                                 show_cancel: true,
                                 collapse_target: "bug-form" %>
                      </div>
                    </div>
                    <% if @bugs.any? %>
                      <div class="list-group">
                        <% @bugs.each do |bug| %>
                          <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <p class="mb-1 fw-semibold"><%= display_user_name(bug.user) %></p>
                              <p class="mb-2"><%= simple_format(bug.comment) %></p>
                              <p class="text-secondary small mb-0"><%= l(bug.created_at, format: :short) %></p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                              <%= button_to upvote_tool_comment_path(@tool, bug),
                                          method: :post,
                                          class: "btn btn-sm #{bug.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                                          title: bug.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                                <span>↑</span> <span><%= bug.upvote_count %></span>
                              <% end %>
                              <% if bug.solved? %>
                                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
                              <% else %>
                                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
                              <% end %>
                              <%# TODO: Re-enable bug resolution when we decide on permissions %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <div class="alert alert-light border"><%= t("comments.empty.bugs") %></div>
                    <% end %>
                  </div>

                  <!-- Flags Tab -->
                  <div class="tab-pane fade" id="flags" role="tabpanel" aria-labelledby="flags-tab">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h6 mb-0"><%= t("tools.show.flags_title") %></h2>
                    </div>
                    <div class="mb-2 d-flex justify-content-between gap-2 align-items-center flex-wrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{tool_path(@tool, sort_by_flags: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{tool_path(@tool, sort_by_flags: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{tool_path(@tool, sort_by_flags: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'trending' ? 'active' : ''}" %>
                      </div>
                      <button class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" data-bs-target="#flag-form"><%= t("comments.actions.add_flag") %></button>
                    </div>
                    <div id="flag-form" class="collapse mb-3">
                      <div class="card card-body">
                        <%= render "comments/form",
                                 tool: @tool,
                                 comment: @new_flag,
                                 submit_label: t("comments.actions.submit_flag"),
                                 placeholder: t("comments.form.flag_placeholder"),
                                 show_cancel: true,
                                 collapse_target: "flag-form" %>
                      </div>
                    </div>
                    <% if @flags.any? %>
                      <div class="list-group">
                        <% @flags.each do |flag| %>
                          <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <p class="mb-1 fw-semibold"><%= display_user_name(flag.user) %></p>
                              <p class="mb-2"><%= simple_format(flag.comment) %></p>
                              <p class="text-secondary small mb-0"><%= l(flag.created_at, format: :short) %></p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                              <%= button_to upvote_tool_comment_path(@tool, flag),
                                          method: :post,
                                          class: "btn btn-sm #{flag.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                                          title: flag.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                                <span>↑</span> <span><%= flag.upvote_count %></span>
                              <% end %>
                              <% if flag.solved? %>
                                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
                              <% else %>
                                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
                              <% end %>
                              <%# TODO: Re-enable flag resolution when we decide on permissions %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <div class="alert alert-light border"><%= t("comments.empty.flags") %></div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Related Submissions - takes 50% of grid size on desktop, full width at bottom on mobile -->
            <% if @related_submissions.any? %>
              <div class="col-12 col-md-6 order-2">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h2 class="h4 mb-0 fw-bold"><%= t("tools.show.related_submissions_title") %></h2>
                      <span class="badge bg-secondary"><%= @related_submissions.size %></span>
                    </div>
                    <div class="row row-cols-1 g-3">
                      <% @related_submissions.each do |submission| %>
                        <div class="col">
                          <%= render "submissions/submission_card", submission: submission %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Ad Banner (columns 11-12) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-start position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>
  </div>
</div>
