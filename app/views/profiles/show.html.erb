<!-- Full-width layout -->
<div class="container py-4">
<div class="container mt-4">
  <!-- Profile Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body pb-3">
          <div class="d-flex align-items-start gap-4">
            <!-- Avatar -->
            <div>
              <% if @user.avatar.attached? %>
                <%= image_tag @user.avatar, class: "rounded", style: "height: 120px; width: 120px; object-fit: cover;" %>
              <% else %>
                <div class="rounded bg-secondary d-flex align-items-center justify-content-center" style="height: 120px; width: 120px;">
                  <span class="text-white fs-1"><%= @user.username.first.upcase %></span>
                </div>
              <% end %>
            </div>

            <!-- Username and Info -->
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h1 class="h3 mb-2"><%= @user.username %></h1>
                  <p class="text-muted mb-2">
                    <%= t("profiles.show.joined") %> <%= l(@user.created_at, format: :long) %>
                  </p>
                </div>
                <!-- Follow Button Container - Stable wrapper for Turbo Stream updates -->
                <% if user_signed_in? && !@is_own_profile %>
                  <div id="<%= dom_id(@user, 'follow') %>" class="follow-button-container">
                    <% if @is_following %>
                      <%= button_to unfollow_user_path(@user.username),
                          method: :delete,
                          class: "btn btn-outline-secondary",
                          data: { turbo: true } do %>
                        <%= t("profiles.follow.unfollow") %>
                      <% end %>
                    <% else %>
                      <%= button_to follow_user_path(@user.username),
                          method: :post,
                          class: "btn btn-primary",
                          data: { turbo: true } do %>
                        <%= t("profiles.follow.follow") %>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <!-- Followers and Following Counts -->
              <div class="d-flex gap-3">
                <span class="text-muted">
                  <strong id="followers-count"><%= @followers_count %></strong> <%= t("profiles.show.followers") %>
                </span>
                <span class="text-muted">
                  <strong id="following-count"><%= @following_count %></strong> <%= t("profiles.show.following") %>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Tabs -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab">
            <%= t("profiles.show.tabs.submissions") %> (<%= @public_submissions.count %>)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab">
            <%= t("profiles.show.tabs.comments") %> (<%= @public_comments.count %>)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="upvotes-tab" data-bs-toggle="tab" data-bs-target="#upvotes" type="button" role="tab">
            <%= t("profiles.show.tabs.upvotes") %> (<%= @public_upvoted_tools.count %>)
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="lists-tab" data-bs-toggle="tab" data-bs-target="#lists" type="button" role="tab">
            <%= t("profiles.show.tabs.lists") %> (<%= @public_lists.count %>)
          </button>
        </li>
      </ul>

      <div class="tab-content" id="profileTabContent">
        <!-- Submissions Tab -->
        <div class="tab-pane fade show active" id="posts" role="tabpanel">
          <% if @public_submissions.any? %>
            <div class="row row-cols-1 row-cols-md-3 g-3">
              <% @public_submissions.each do |submission| %>
                <div class="col">
                  <%= render "submissions/submission_card_compact", submission: submission %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted"><%= t("profiles.show.tabs.no_submissions") %></p>
          <% end %>
        </div>

        <!-- Comments Tab -->
        <div class="tab-pane fade" id="comments" role="tabpanel">
          <% if @public_comments.any? %>
            <div class="row row-cols-1 row-cols-md-3 g-3">
              <% @public_comments.each do |comment| %>
                <div class="col">
                  <div class="card shadow-sm h-100 card-hover">
                    <div class="card-body">
                      <h6 class="card-title mb-2">
                        <% if comment.commentable_type == "Tool" %>
                          <%= link_to comment.commentable.tool_name, tool_path(comment.commentable), class: "text-decoration-none" %>
                        <% elsif comment.commentable_type == "Submission" %>
                          <%= link_to comment.commentable.submission_name.presence || comment.commentable.submission_url, submission_path(comment.commentable), class: "text-decoration-none" %>
                        <% end %>
                      </h6>
                      <p class="card-text text-muted mb-2"><%= truncate(comment.comment, length: 150) %></p>
                      <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">
                          <%= l(comment.created_at, format: :short) %>
                        </small>
                        <% if comment.comment_type != "comment" %>
                          <span class="badge bg-secondary"><%= comment.comment_type.humanize %></span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted"><%= t("profiles.show.tabs.no_comments") %></p>
          <% end %>
        </div>

        <!-- Upvotes Tab -->
        <div class="tab-pane fade" id="upvotes" role="tabpanel">
          <% if @public_upvoted_tools.any? %>
            <div class="row row-cols-1 row-cols-md-3 g-3">
              <% @public_upvoted_tools.each do |tool| %>
                <div class="col">
                  <%= render "pages/tool_card_compact", tool: tool %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted"><%= t("profiles.show.tabs.no_upvotes") %></p>
          <% end %>
        </div>

        <!-- Lists Tab -->
        <div class="tab-pane fade" id="lists" role="tabpanel">
          <% if @public_lists.any? %>
            <div class="row row-cols-1 row-cols-md-3 g-3">
              <% @public_lists.each do |list| %>
                <div class="col">
                  <div class="card shadow-sm h-100 card-hover">
                    <div class="card-body">
                      <h5 class="card-title mb-2">
                        <%= link_to list.list_name, list_path(list), class: "text-decoration-none" %>
                      </h5>
                      <p class="card-text text-muted small mb-2">
                        <%= l(list.created_at, format: :short) %>
                        • <%= t("profiles.show.tabs.tools_count", count: list.tools.count) %>
                        <% unless user_signed_in? && list.user == current_user && @user == current_user %>
                          • <%= t("profiles.show.tabs.by_user", username: link_to(list.user.username, profile_path(list.user.username), class: "text-decoration-none")).html_safe %>
                        <% end %>
                        <span id="<%= dom_id(list, 'follow') %>-count">
                          <% if list.follower_count > 0 %>
                            • <%= t("profiles.show.followers") %>: <%= list.follower_count %>
                          <% end %>
                        </span>
                      </p>
                      <% if user_signed_in? && current_user != list.user %>
                        <div id="<%= dom_id(list, 'follow') %>" class="follow-button-container">
                          <% if @followed_list_ids.include?(list.id) %>
                            <%= button_to unfollow_list_path(list),
                                method: :delete,
                                class: "btn btn-outline-secondary btn-sm",
                                data: { turbo: true } do %>
                              <%= t("lists.follow.unfollow") %>
                            <% end %>
                          <% else %>
                            <%= button_to follow_list_path(list),
                                method: :post,
                                class: "btn btn-primary btn-sm",
                                data: { turbo: true } do %>
                              <%= t("lists.follow.follow") %>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted"><%= t("profiles.show.tabs.no_lists") %></p>
          <% end %>
        </div>
      </div>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>
</div>
