<%= simple_form_for(@submission, 
    html: { 
      data: { 
        controller: "submission-form",
        submission_form_validate_url_value: validate_url_submissions_path,
        submission_form_submission_id_value: @submission.id || nil,
        action: "submit->submission-form#validateBeforeSubmit"
      }
    }
  ) do |f| %>
  
  <%# Subscribe to Turbo Stream updates if submission exists %>
  <% if @submission.persisted? %>
    <%= turbo_stream_from "submission_#{@submission.id}" %>
  <% end %>
  
  <%# Processing status will be inserted here via Turbo Streams %>
  <div id="submission-processing-status-container"></div>

  <div class="row g-4" data-submission-form-target="formContainer">
    <div class="col-12">
      <label class="form-label fw-semibold mb-2">
        <%= t("submissions.form.submission_url") %>
        <% if @submission.new_record? %>
          <span class="text-danger">*</span>
        <% end %>
      </label>
      <%= f.input :submission_url, 
          label: false,
          required: false,
          hint: t("submissions.form.submission_url_hint"),
          input_html: { 
            class: "form-control",
            placeholder: "https://example.com/article",
            autocomplete: "off",
            data: { 
              submission_form_target: "urlInput",
              action: "input->submission-form#urlChanged"
            }
          } %>
    </div>

    <%# Validation messages %>
    <div class="col-12" data-submission-form-target="validationMessage" style="display: none;"></div>

    <%# Similar submissions warning %>
    <div class="col-12" data-submission-form-target="similarSubmissions" style="display: none;"></div>

    <%# Processing status %>
    <div class="col-12" data-submission-form-target="processingStatus" style="display: none;">
      <div class="alert alert-info d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span data-submission-form-target="statusText">Processing...</span>
      </div>
    </div>

    <%# Show additional fields when editing (especially for admins) %>
    <% if @submission.persisted? %>
      <div class="col-12">
        <label class="form-label fw-semibold mb-2">
          <%= t("submissions.form.submission_name") %>
          <span class="text-muted small fw-normal">(<%= t("submissions.form.optional") %>)</span>
        </label>
        <%= f.input :submission_name,
            label: false,
            input_html: { 
              class: "form-control",
              placeholder: t("submissions.form.submission_name_hint")
            },
            hint: t("submissions.form.submission_name_hint") %>
      </div>

      <div class="col-12">
        <label class="form-label fw-semibold mb-2">
          <%= t("submissions.form.submission_description") %>
          <span class="text-muted small fw-normal">(<%= t("submissions.form.optional") %>)</span>
        </label>
        <%= f.input :submission_description,
            as: :text,
            label: false,
            input_html: { 
              class: "form-control",
              rows: 5,
              placeholder: t("submissions.form.submission_description_hint")
            },
            hint: t("submissions.form.submission_description_hint") %>
      </div>

      <%# Tool selection (for admins) %>
      <% if admin_user? && defined?(@available_tools) && @available_tools.present? %>
        <div class="col-12">
          <label class="form-label fw-semibold mb-2">
            <%= t("submissions.form.tools") %>
            <span class="text-muted small fw-normal">(<%= t("submissions.form.optional") %>)</span>
          </label>
          <div class="border rounded p-3" style="min-height: 150px; max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
            <% @available_tools.each do |tool| %>
              <div class="form-check">
                <%= check_box_tag "submission[tool_ids][]", tool.id, @submission.tools.include?(tool), 
                    id: "submission_tool_ids_#{tool.id}",
                    class: "form-check-input" %>
                <%= label_tag "submission_tool_ids_#{tool.id}", tool.tool_name, class: "form-check-label" %>
              </div>
            <% end %>
          </div>
          <small class="form-text text-muted"><%= t("submissions.form.tools_hint") %></small>
        </div>
      <% end %>

      <%# Submission type and status (for admins only) %>
      <% if admin_user? %>
        <div class="col-12 col-md-6">
          <label class="form-label fw-semibold mb-2">
            <%= t("submissions.form.submission_type") %>
          </label>
          <%= f.input :submission_type,
              as: :select,
              collection: Submission.submission_types.keys.map { |type| [t("submissions.types.#{type}"), type] },
              label: false,
              input_html: { class: "form-select" },
              hint: t("submissions.form.submission_type_hint") %>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label fw-semibold mb-2">
            <%= t("submissions.form.status") %>
          </label>
          <%= f.input :status,
              as: :select,
              collection: Submission.statuses.keys.map { |status| [t("submissions.statuses.#{status}"), status] },
              label: false,
              input_html: { class: "form-select" },
              hint: t("submissions.form.status_hint") %>
        </div>
      <% end %>
    <% end %>

    <div class="col-12">
      <label class="form-label fw-semibold mb-2">
        <%= t("submissions.form.author_note") %>
        <span class="text-muted small fw-normal">(<%= t("submissions.form.optional") %>)</span>
      </label>
      <%= f.input :author_note, 
          as: :text, 
          label: false,
          input_html: { 
            class: "form-control",
            rows: 3,
            placeholder: t("submissions.form.author_note_placeholder"),
            data: { submission_form_target: "authorNoteInput" }
          },
          hint: t("submissions.form.author_note_hint") %>
    </div>
  </div>

  <div class="mt-4 pt-3 border-top d-flex gap-2">
    <%= f.button :submit, 
        class: "btn btn-primary btn-lg",
        disabled: @submission.new_record?,
        data: { submission_form_target: "submitButton" } do %>
      <i class="bi bi-send me-2"></i>
      <%= @submission.new_record? ? t("submissions.form.submit") : t("actions.update") %>
    <% end %>
    <%= link_to t("actions.cancel"), @submission.persisted? ? submission_path(@submission) : submissions_path, class: "btn btn-outline-secondary btn-lg" %>
  </div>
<% end %>

