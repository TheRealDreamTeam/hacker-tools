<%# Subscribe to Turbo Stream updates for real-time processing status %>
<%= turbo_stream_from "submission_#{@submission.id}" %>

<!-- Full-width layout with side banners -->
<div class="container-fluid px-0">
  <div class="row g-0">
    <!-- Left Ad Banner (columns 1-2) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-end position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>

    <!-- Main Content (columns 3-10) - adjusted for wider banners -->
    <div class="col-12 col-lg-8">
      <div class="container py-4">
        <div class="p-2">
          <%# Processing status container (updated via Turbo Streams) %>
          <div id="submission-processing-status-container"></div>
          
          <!-- Submission Card - full width -->
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card shadow-sm d-flex flex-column position-relative" style="border: 4px solid #FFC65A !important;">
                <div class="card-body d-flex flex-column position-relative" style="background-color: #fffbf0;">
                  <!-- Submission Container with Title and Back Button on same height -->
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                        <h1 class="h3 mb-0" id="submission-title">
                          <%= @submission.submission_name.presence || @submission.submission_url %>
                        </h1>
                        <% if @submission.submission_url.present? %>
                          <%= link_to @submission.submission_url, target: "_blank", rel: "noopener noreferrer", class: "btn btn-sm btn-outline-primary visit-source-btn" do %>
                            <%= t("actions.visit_source") %>
                            <i class="bi bi-box-arrow-up-right"></i>
                          <% end %>
                        <% end %>
                      </div>
                      <div class="d-flex align-items-center gap-2 mb-2" id="submission-status-badges">
                        <span class="badge bg-primary">
                          <%= t("submissions.types.#{@submission.submission_type}") %>
                        </span>
                        <% if @submission.status != "completed" %>
                          <span class="badge bg-warning text-dark">
                            <%= t("submissions.statuses.#{@submission.status}") %>
                          </span>
                        <% end %>
                      </div>
                      <p class="text-secondary mb-1 d-flex align-items-center gap-2">
                        <span>
                          <%= t("submissions.by_user", user: link_to(display_user_name(@submission.user), profile_path(@submission.user.username), class: "text-decoration-none")).html_safe %>
                        </span>
                      </p>
                      <div id="submission-tools-section">
                        <% if @submission.tools.any? %>
                          <p class="mb-0 text-secondary">
                            <%= raw t("submissions.about_tools", tools: @submission.tools.map { |t| link_to(t.tool_name, tool_path(t), class: "text-decoration-none") }.join(", ").html_safe) %>
                          </p>
                        <% end %>
                      </div>
                    </div>
                    <div class="d-flex gap-2 align-items-start">
                      <!-- Back Button - same height as title -->
                      <div>
                        <% if @submission.user == current_user %>
                          <%= link_to t("actions.edit"), edit_submission_path(@submission), class: "btn btn-outline-primary" %>
                          <%= render "shared/confirmation_modal",
                              id: "delete-submission-modal",
                              title: t("submissions.confirmations.destroy_title"),
                              message: t("submissions.confirmations.destroy_message"),
                              confirm_text: t("actions.delete"),
                              confirm_class: "btn-outline-danger",
                              form_action: submission_path(@submission),
                              form_method: :delete %>
                          <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#delete-submission-modal">
                            <%= t("actions.delete") %>
                          </button>
                        <% end %>
                        <%= link_to t("actions.back"), submissions_path, class: "btn btn-secondary" %>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <%= render "interaction_buttons", submission: @submission %>
                  </div>
                  <div class="mb-4" id="submission-description-section">
                    <div class="row g-3 align-items-start">
                      <div class="col-12 col-md-6">
                        <h2 class="h5"><%= t("submissions.show.description") %></h2>
                        <p id="submission-description"><%= simple_format(@submission.submission_description.presence || @submission.author_note) %></p>
                      </div>
                      <div class="col-12 col-md-6 d-flex flex-column gap-3 align-items-start">
                        <% if @submission.icon.attached? %>
                          <!-- Submission Logo - responsive size based on viewport -->
                          <%= image_tag @submission.icon,
                              class: "img-fluid rounded",
                              style: "max-width: 150px; width: 100%; height: auto; object-fit: contain;",
                              alt: "#{@submission.submission_name} logo" %>
                        <% end %>
                        <% if @submission.author_note.present? && @submission.submission_description.present? %>
                          <!-- Author Note - same height as description, more to the left on large screens, narrower and taller -->
                          <div class="alert alert-info border-start border-4 d-flex align-items-start gap-2 ms-lg-n3" role="note" style="max-width: 85%; width: 85%; min-height: 120px;">
                            <i class="bi bi-chat-left-text flex-shrink-0 mt-1" style="font-size: 1.25rem;"></i>
                            <div class="flex-grow-1">
                              <h6 class="alert-heading mb-2 fw-semibold text-dark"><%= t("submissions.show.author_note") %></h6>
                              <div class="mb-0"><%= simple_format(@submission.author_note) %></div>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <% if @submission.picture.attached? %>
                    <div class="mb-4">
                      <h2 class="h5"><%= t("submissions.show.picture") %></h2>
                      <%= image_tag @submission.picture, class: "img-fluid rounded" %>
                    </div>
                  <% end %>
                  
                  <!-- Tags -->
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h5 mb-0"><%= t("submissions.show.tags_title") %></h2>
                      <%# Tag management hidden - tags will be auto-generated during processing pipeline %>
                      <%# TODO: Re-enable manual tag management in future if needed %>
                    </div>
                    <div id="submission-tags">
                      <%= render "tags_section", submission: @submission %>
                    </div>
                  </div>
                  <span class="position-absolute bottom-0 end-0 mb-1 me-1">
                    <%= render "submissions/read_state", submission: @submission %>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Discussion/Comments/Bugs/Flags with Tabs - takes 50% of grid size, Related Tools takes 50% on desktop -->
          <div class="row g-4 mb-4">
            <div id="discussion-section" class="col-12 col-md-6 order-1">
              <div>
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="discussion-tab" data-bs-toggle="tab" data-bs-target="#discussion" type="button" role="tab" aria-controls="discussion" aria-selected="true">
                      <%= t("submissions.show.comments_title") %>
                      <span class="badge bg-secondary ms-2"><%= @comments.count.to_s %></span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bugs-tab" data-bs-toggle="tab" data-bs-target="#bugs" type="button" role="tab" aria-controls="bugs" aria-selected="false">
                      <%= t("submissions.show.bugs_title") %>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flags-tab" data-bs-toggle="tab" data-bs-target="#flags" type="button" role="tab" aria-controls="flags" aria-selected="false">
                      <%= t("submissions.show.flags_title") %>
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                  <!-- Discussion Tab -->
                  <div class="tab-pane fade show active" id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
                    <div class="mb-3">
                      <%= render "comments/form", commentable: @submission, comment: @new_comment, submit_label: t("comments.actions.post_comment"), placeholder: t("comments.form.comment_placeholder") %>
                    </div>
                    <div class="mb-2">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{submission_path(@submission, sort_by: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{submission_path(@submission, sort_by: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{submission_path(@submission, sort_by: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by == 'trending' ? 'active' : ''}" %>
                      </div>
                    </div>
                    <div id="comments-list">
                      <% if @comments.any? %>
                        <% @comments.each do |comment| %>
                          <%= render "comments/comment", comment: comment, depth: 0, allow_replies: true %>
                        <% end %>
                      <% else %>
                        <div id="comments-empty" class="alert alert-light border"><%= t("comments.empty.comments") %></div>
                      <% end %>
                    </div>
                  </div>

                  <!-- Bugs Tab -->
                  <div class="tab-pane fade" id="bugs" role="tabpanel" aria-labelledby="bugs-tab">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h6 mb-0"><%= t("submissions.show.bugs_title") %></h2>
                    </div>
                    <div class="mb-2 d-flex justify-content-between gap-2 align-items-center flex-wrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{submission_path(@submission, sort_by_bugs: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{submission_path(@submission, sort_by_bugs: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{submission_path(@submission, sort_by_bugs: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_bugs == 'trending' ? 'active' : ''}" %>
                      </div>
                      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="collapse" data-bs-target="#bug-form"><%= t("comments.actions.add_bug") %></button>
                    </div>
                    <div id="bug-form" class="collapse mb-3">
                      <div class="card card-body">
                        <%= render "comments/form",
                                 commentable: @submission,
                                 comment: @new_bug,
                                 submit_label: t("comments.actions.submit_bug"),
                                 placeholder: t("comments.form.bug_placeholder"),
                                 show_cancel: true,
                                 collapse_target: "bug-form" %>
                      </div>
                    </div>
                    <% if @bugs.any? %>
                      <div class="list-group">
                        <% @bugs.each do |bug| %>
                          <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <p class="mb-1 fw-semibold"><%= display_user_name(bug.user) %></p>
                              <p class="mb-2"><%= simple_format(bug.comment) %></p>
                              <p class="text-secondary small mb-0"><%= l(bug.created_at, format: :short) %></p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                              <%= button_to upvote_submission_comment_path(@submission, bug),
                                          method: :post,
                                          class: "btn btn-sm #{bug.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                                          title: bug.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                                <span>↑</span> <span><%= bug.upvote_count %></span>
                              <% end %>
                              <% if bug.solved? %>
                                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
                              <% else %>
                                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
                              <% end %>
                              <% if @submission.user == current_user %>
                                <%= button_to t("comments.actions.toggle_resolve"),
                                            resolve_submission_comment_path(@submission, bug),
                                            method: :patch,
                                            class: "btn btn-sm btn-outline-primary" %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <div class="alert alert-light border"><%= t("comments.empty.bugs") %></div>
                    <% end %>
                  </div>

                  <!-- Flags Tab -->
                  <div class="tab-pane fade" id="flags" role="tabpanel" aria-labelledby="flags-tab">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h2 class="h6 mb-0"><%= t("submissions.show.flags_title") %></h2>
                    </div>
                    <div class="mb-2 d-flex justify-content-between gap-2 align-items-center flex-wrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <%= link_to t("comments.sort.recent"), "#{submission_path(@submission, sort_by_flags: 'recent')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'recent' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.most_upvoted"), "#{submission_path(@submission, sort_by_flags: 'most_upvoted')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'most_upvoted' ? 'active' : ''}" %>
                        <%= link_to t("comments.sort.trending"), "#{submission_path(@submission, sort_by_flags: 'trending')}#discussion-section", class: "btn btn-outline-secondary #{@sort_by_flags == 'trending' ? 'active' : ''}" %>
                      </div>
                      <button class="btn btn-sm btn-outline-warning" data-bs-toggle="collapse" data-bs-target="#flag-form"><%= t("comments.actions.add_flag") %></button>
                    </div>
                    <div id="flag-form" class="collapse mb-3">
                      <div class="card card-body">
                        <%= render "comments/form",
                                 commentable: @submission,
                                 comment: @new_flag,
                                 submit_label: t("comments.actions.submit_flag"),
                                 placeholder: t("comments.form.flag_placeholder"),
                                 show_cancel: true,
                                 collapse_target: "flag-form" %>
                      </div>
                    </div>
                    <% if @flags.any? %>
                      <div class="list-group">
                        <% @flags.each do |flag| %>
                          <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <p class="mb-1 fw-semibold"><%= display_user_name(flag.user) %></p>
                              <p class="mb-2"><%= simple_format(flag.comment) %></p>
                              <p class="text-secondary small mb-0"><%= l(flag.created_at, format: :short) %></p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                              <%= button_to upvote_submission_comment_path(@submission, flag),
                                          method: :post,
                                          class: "btn btn-sm #{flag.upvoted_by?(current_user) ? 'btn-primary' : 'btn-outline-secondary'}",
                                          title: flag.upvoted_by?(current_user) ? t("comments.actions.remove_upvote") : t("comments.actions.upvote") do %>
                                <span>↑</span> <span><%= flag.upvote_count %></span>
                              <% end %>
                              <% if flag.solved? %>
                                <span class="badge bg-success"><%= t("comments.labels.resolved") %></span>
                              <% else %>
                                <span class="badge bg-warning text-dark"><%= t("comments.labels.unresolved") %></span>
                              <% end %>
                              <% if @submission.user == current_user %>
                                <%= button_to t("comments.actions.toggle_resolve"),
                                            resolve_submission_comment_path(@submission, flag),
                                            method: :patch,
                                            class: "btn btn-sm btn-outline-primary" %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <div class="alert alert-light border"><%= t("comments.empty.flags") %></div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Related Tools - takes 50% of grid size on desktop, full width at bottom on mobile -->
            <% if @submission.tools.any? %>
              <div class="col-12 col-md-6 order-2">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h2 class="h4 mb-0 fw-bold"><%= t("submissions.show.related_tools_title") %></h2>
                      <span class="badge bg-secondary"><%= @submission.tools.size %></span>
                    </div>
                    <div class="submission-show-related-tools row row-cols-1 g-3">
                      <% @submission.tools.each do |tool| %>
                        <div class="col">
                          <%= render "pages/tool_card", tool: tool %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Ad Banner (columns 11-12) - extended inward toward main content -->
    <div class="col-lg-2 d-none d-lg-block side-banner ps-5 pe-5">
      <div class="card h-100 rounded-0 border-0 border-start position-relative overflow-hidden" style="border-radius: 0 !important; background-image: url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=300&h=800&fit=crop'); background-size: cover; background-position: center;">
        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.4) 100%);"></div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-3 position-relative z-1">
          <p class="fw-semibold mb-1 text-white">Sponsors</p>
          <p class="text-white-50 small mb-0"><%= t("pages.home.ads.supporting_text") %></p>
        </div>
      </div>
    </div>
  </div>
</div>

